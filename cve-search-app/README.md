# CVE Search Next.js Application

This document provides a detailed overview of the Next.js frontend application for the CVE Search Engine. For information about the overall project, data ingestion, and Supabase setup, please see the [main project README.md](../../README.md).

## Overview

This application provides a user interface for searching a database of Common Vulnerabilities and Exposures (CVEs) using natural language queries. It leverages a Large Language Model (LLM) via Together AI to translate user queries into structured search parameters, which are then used to query a Supabase PostgreSQL database.

## Core Technologies

-   **Next.js:** React framework for server-side rendering and static site generation.
-   **TypeScript:** For type safety and improved developer experience.
-   **Vercel AI SDK:** Used for interacting with the LLM (Together AI). Specifically, it facilitates:
    -   Defining "tools" that the LLM can be instructed to use.
    -   Generating structured data (tool arguments) from the LLM based on the natural language query.
-   **Together AI:** Provides the underlying LLM (e.g., Qwen, Llama models) for natural language understanding and query transformation.
-   **Supabase:**
    -   **PostgreSQL Database:** Stores the `rich_cve_entries` view, which is the target for search queries.
    -   **Supabase Client Libraries (`@supabase/ssr`, `@supabase/supabase-js`):** Used for connecting to and querying the database from the Next.js application.
-   **Tailwind CSS:** For styling the user interface.
-   **Zod:** For schema validation, particularly for the LLM tool inputs.

## Project Structure (`cve-search-app`)

-   `app/`: Core application directory for Next.js App Router.
    -   `page.tsx`: The main search interface page (client component).
    -   `actions.ts`: Server actions, including:
        -   `searchCVEsAction`: Orchestrates the entire search process.
        -   `getToolArgumentsForCVESearch`: Interacts with the LLM using Vercel AI SDK and a defined tool to get structured search parameters.
        -   `buildSqlConditionsFromToolArguments`: Converts the LLM-generated tool arguments into SQL `WHERE` clauses.
-   `components/`: Reusable UI components.
    -   `ui/`: Shadcn/ui components.
-   `utils/`: Utility functions.
    -   `supabase/`: Supabase client and server setup.
        -   `client.ts`: Browser-side Supabase client.
        -   `server.ts`: Server-side Supabase client (used in server actions).
-   `public/`: Static assets.
-   `README.md`: This file.

## AI Agent Logic & Search Flow

1.  **User Input:** The user enters a natural language query (e.g., "vulnerabilities related to Apache from last month") into the UI in `app/page.tsx`.
2.  **Server Action Triggered:** The `searchCVEsAction` in `app/actions.ts` is called.
3.  **LLM Interaction (`getToolArgumentsForCVESearch`):**
    -   A system prompt instructs the LLM (via Together AI, configured with `TOGETHER_API_KEY` and `TOGETHER_BASE_URL`) to act as an assistant that calls a specific tool named `searchCVEsTool`.
    -   The `searchCVEsTool` is defined using `tool()` from the Vercel AI SDK and has a Zod schema (`CveSearchToolInputSchema`) specifying the expected arguments (e.g., `keywords`, `severities`, `date_range`, `cwe_ids`).
    -   The Vercel AI SDK's `generateText` function is used with the `tools` option to get the LLM to "call" this tool by providing the arguments it deems appropriate based on the natural language query.
4.  **SQL Condition Generation (`buildSqlConditionsFromToolArguments`):**
    -   The structured arguments extracted from the LLM's tool call are deterministically converted into an array of SQL `WHERE` clause strings. For example, keywords become `ILIKE` conditions on `description_text` or `cve_id`.
5.  **Database Query:**
    -   A base SQL query `SELECT * FROM rich_cve_entries` is formed.
    -   If the LLM generated valid SQL conditions, they are appended using `WHERE ... AND ...`.
    -   The Supabase server client executes this query against the `rich_cve_entries` view using a PostgreSQL function `public.execute_sql(sql_query TEXT)`. This function was created manually in Supabase to allow dynamic SQL execution.
6.  **Results Display:** The query results (or any errors) are returned to `app/page.tsx` and displayed to the user. The UI also shows the LLM's interpretation (tool arguments) and the generated SQL conditions for transparency.

## Environment Variables

The Next.js application relies on the following environment variables (typically set in `.env.local`):

-   `NEXT_PUBLIC_SUPABASE_URL`: Public URL for your Supabase project.
-   `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Public anonymous key for your Supabase project (for client-side access).
-   `SUPABASE_SERVICE_ROLE_KEY`: Service role key for your Supabase project (for server-side/admin access, used in `server.ts`).
-   `TOGETHER_API_KEY`: Your API key for Together AI.
-   `TOGETHER_BASE_URL`: (Optional, defaults if not set) The base URL for the Together AI API, usually `https://api.together.xyz/v1`.
-   `ANALYST_MODEL`: (Currently hardcoded in `actions.ts`) The specific LLM model to use from Together AI (e.g., 'Qwen/Qwen3-235B-A22B-fp8-tput').
-   `ANALYST_TEMPERATURE`: (Currently hardcoded in `actions.ts`) The temperature setting for the LLM.

## Running the Application

1.  Ensure you have Node.js and npm/yarn installed.
2.  Navigate to the `cve-search-app` directory.
3.  Create a `.env.local` file in the `cve-search-app` directory and populate it with the necessary environment variables listed above.
4.  Install dependencies:
    ```bash
    npm install
    # or
    yarn install
    ```
5.  Run the development server:
    ```bash
    npm run dev
    # or
    yarn dev
    ```
    The application will typically be available at `http://localhost:3000`.

Refer to the [main project README.md](../../README.md) for instructions on setting up Supabase, creating the `rich_cve_entries` view, and the `execute_sql` PostgreSQL function. 